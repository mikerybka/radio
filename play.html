<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Audio Stream</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center">

  <button id="toggle" class="flex items-center justify-center gap-2 bg-black text-white px-6 py-4 rounded-2xl text-xl sm:text-lg font-semibold shadow-md disabled:opacity-50 disabled:cursor-not-allowed w-11/12 sm:w-auto">
    <svg id="spinner" class="hidden animate-spin h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
    </svg>
    <span id="buttonText">Start</span>
  </button>

  <div id="error" class="mt-4 text-red-600 text-sm font-medium text-center"></div>

  <audio id="stream"></audio>

  <script>
    const button = document.getElementById("toggle");
    const buttonText = document.getElementById("buttonText");
    const spinner = document.getElementById("spinner");
    const errorDiv = document.getElementById("error");
    const audio = document.getElementById("stream");

    const baseStreamURL = "https://radio.mikerybka.com/live.mp3";
    let isPlaying = false;
    let retryCount = 0;
    const maxRetries = 5;

    let stallTimeout;
    let lastTime = 0;

    function setLoading(state) {
      button.disabled = state;
      spinner.classList.toggle("hidden", !state);
    }

    function resetAudio() {
      audio.pause();
      audio.removeAttribute("src");
      audio.load();
      isPlaying = false;
      buttonText.textContent = "Start";
      clearTimeout(stallTimeout);
    }

    function monitorStream() {
      clearTimeout(stallTimeout);
      lastTime = audio.currentTime;

      stallTimeout = setTimeout(() => {
        if (!audio.paused && audio.currentTime === lastTime) {
          console.warn("Stream appears stalled. Retrying...");
          errorDiv.textContent = "Stream stalled. Retrying...";
          resetAudio();
          playStream();
        } else {
          monitorStream();
        }
      }, 3000);
    }

    function playStream() {
      setLoading(true);
      const url = baseStreamURL + "?ts=" + Date.now();
      audio.src = url;
      audio.load();
      audio.play().then(() => {
        isPlaying = true;
        retryCount = 0;
        buttonText.textContent = "Stop";
        errorDiv.textContent = "";
        setLoading(false);
        monitorStream();
      }).catch(err => {
        console.error("play() failed:", err);
        errorDiv.textContent = "Playback failed: " + err.message;
        setLoading(false);
      });
    }

    button.addEventListener("click", () => {
      errorDiv.textContent = "";
      if (!isPlaying) {
        playStream();
      } else {
        resetAudio();
      }
    });

    audio.addEventListener("pause", () => {
      clearTimeout(stallTimeout);
    });

    audio.addEventListener("error", (e) => {
      console.warn("audio.onerror triggered", e);
    });
  </script>
</body>
</html>
